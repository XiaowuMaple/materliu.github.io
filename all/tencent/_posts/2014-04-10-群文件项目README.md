---
layout: post
title: 2014-04-10-群文件项目README.md
---

### 打开readme文件的同学，如果本机没有安装markdown相关的查看编辑器可以选用在线版： https://stackedit.io/
# 群文件项目README

接口人： materliu
后台: wingspeng
产品: danyye

## Documentation

### relational link
[前台wiki][1] 一般以README.md文件为准，内网wiki算是个摆设了

[CGI Wiki]()

[Moniter 视图](http://monitor.server.com/link/graph/viewid:6196)

[performance 视图]() 选择外部门业务-R1平台研发系统-我的QQ中心

[mm上报系统视图]() 上报是5分钟实时，告警大概是5-10分钟延迟  页面展示会大概15分钟

[伯努利上报系统视图]()

[dc上报系统视图]()

[dc 群数据的上报格式](http://dc.dt.oa.com/dcreports/edit?dcid=dc00141&timestamp=1395555959)

[本地构建工具grunt学习](http://gruntjs.com/)

[图片压缩服务](http://www.smushit.com/)

[移动web项目前端上线前检查项](https://docs.google.com/spreadsheets/d/1J7cFLKONZdkfi4ZeETwCceGfu5pryO__1bAtglqVcUg/edit#gid=0)

[svn地址-trunk](https://tc-svn.tencent.com/basic/basic_imweb_rep/qun_proj/trunk/htdocs/pan.qun.qq.com)
[svn地址-branches](http://tc-svn.tencent.com/basic/basic_imweb_rep/qun_proj/branches/pan.qun.qq.com)
[svn地址-tags](http://tc-svn.tencent.com/basic/basic_imweb_rep/qun_proj/tags/pan.qun.qq.com)

### 快速上手

#### 项目说明

群文件使用了grunt这一自动构建工具


如图所示:

* docs目录下存放所有的规范类文档；
* dist目录是grunt生成的处理后的代码目录，不需要主动编辑；
* test是自动化测试目录，现在尚未加入，预留功能；


clt_filetab目录根目录下的几个文件：

* .jshintrc  jshint 代码检测的配置文件
* bower.json bower 的配置文件， 暂时未用到(2014/02/26)
* Gruntfile.js grunt 的配置文件
* package.json 整个项目其实相当于一个大的nodejs项目，package.json规定了这个nodjs项目用到的所有node_modules
* proj-conf.json  这个是群web团队自己开发的grunt-task 需要去读的配置文件， 包括项目名，cdn版本，等信息，具体参见文件内注释
* proj-task目录是grunt编译工具引用到的所有task的存放目录
* src 所有的逻辑代码


最外层目录有

* README.doc  项目的说明文件， 群那边同学交接的时候输出的doc
* clt_filetab_preview  以前的项目目录，已经废弃
* m  一个空的文件夹，问了群相关同学knightli无用的目录
* clt_filetab  现在项目的开发目录， 只需要关注此目录即可

#### 业务体验
* 打开一个群聊天窗口， 点击上方的 文件 tab


#### 本地环境搭建
* 前台页面路径为： http://pan.qun.qq.com/clt_filetab/groupShareClient.html

* 内嵌访问路径: http://pan.qun.qq.com/clt_filetab/groupShareClient.html?guin=群号&visitor=0

* 群文件使用了pc端的zip缓存， zip包id是121  目录为： D:\Users\materliu\documents\714512197\AppWebCache D:\Users\materliu\documents\ 为你的QQ文件目录  714512197 为QQ号码

* 相关域名

    - 主域名:
    pan.qun.qq.com
    - cdn:
    qplus4.idqqimg.com
    qplus5.idqqimg.com
    qplus6.idqqimg.com
    - cdn path: /qun/pan/clt_filetab/


#### 跑起来

* 本地访问方法： 直接使用fiddler代理，将http://pan.qun.qq.com/clt_filetab/ 的请求指向本地项目目录。

* 测试环境及IP

    使用nohost, [具体配置见配置系统](http://imweb.server.com/im_nohost_mgr/index.php/apps/get/99)   (系统申请权限找littenli)

* 采用grunt构建

      之前写过一个编译发布指南, 在docs\编译发布指南.md
      (注:由于miller后来对grunt 的task有一些更新, 所以这个文档可能需要miller回来更新一下)

* 部署测试环境访问：

端口号使用 36000 账号是***  密码是： pass4devne****


# 编译发布

## 一、准备

### 1. 检出

check out本目录

### 2. 安装npm依赖包

确保本机已安装nodejs和npm, 然后在根目录运行

```
npm install
```

### 3. 给几个npm包打补丁

前往`tools`目录, 运行

```
node node_modules_patch.js
```

或直接运行 `node_modules_patch.bat` (windows下)


### 4. 准备完毕!


## 二、编译

### 两条主要的编译命令：

####1 编译web发布资源:
```
grunt dist
```

####2 编译本地化资源
```
grunt ct:o
```

### 注意点

####1. 编译前, 请 **务必保证** 本地的: `src目录`, `proj-task目录`, `Gruntfile.js`是干净的, 符合预期的!

####2. 每次提测前,需要确认发布的版本号, 并保证资源的url路径以及版本号在如下三个地方正确、一致:

#####1) 本地: `proj-conf.json`

决定了html页面里的cdn资源引用路径

#####2) 本地: `proj-task/proj/proj-task.js`

决定了本地化资源的js/css资源,能够按照web发布系统相同的版本号方式放置在正确的路径下

#####3) web发布系统: `添加前台发布` - `JS版本` `CSS版本`

决定了web发布系统如何将svn拉下来的web发布资源压缩后放在对应的版本号目录下

####3. 为了发布进行的编译,需要确保Gruntfile.js内的发布开关`isPublicDist`被打开

####4. 关于本地化:

1) 本地化在需要部署灰度的情况下, 谨慎使用(准备在群文件里用一个无功能变更的版本灰度验证以后再使用)

2) 本地化时, 如果需要把外部资源也打包, 请手动在`tools/dist-client-local-external`目录下放置外部资源


## 三、Web测试环境部署

群文件项目目前暂时只有一个测试环境(TODO:增加测试环境)

但有两个发布项目:

  - [群共享_clt_filetab](http://svn.server.com/index.php/PublishItem/index/public_id/287)

  - [群共享_clt_filetab_bugfix](http://svn.server.com/index.php/PublishItem/index/public_id/300)

注意两者的作用和svn来源不同:

1) `群共享_clt_filetab`

- 作用: 主干发布(新特性,新迭代)

- svn来源: `trunk/htdocs/pan.qun.qq.com/clt_filetab/dist`

2) `群共享_clt_filetab_bugfix`

- 作用: bugfix分支发布(从tag拉出来的:`线上版本`或`测试通过版本`的bugfix)

- svn来源: `branches/pan.qun.qq.com/clt_filetab_bugfix`

## 四、ARS发布

1. 从Web测试环境同步资源到ARS编译机

在Web发布系统上, 点`发布`按钮即可.

2. 在ARS上提测试单.

注意：

1）静态和CDN要分别提两个单。

以群文件为例，静态和cdn分别在如下两个目录：
![Alt text](data:image,local://1388042236643)

2）选文件时，谨慎选择整个目录，务必进入到目录确认是否为要发布的资源

3）CDN的单，选文件的时候，可以进到css和js目录下，选择版本号目录

4）静态的单，如果加了CDN切换的功能，那么在勾选静态页面外，`一定记得把静态资源也选上`。

`todo` web发布系统或者grunt内可以考虑增加功能，自动输出本次发布涉及的文件列表，让我们`可以直接把这个列表粘贴到ars的发布单里去`。

3. ARS测试部署-> 测试 -> 预发布 -> 发布

一般这几个步骤测试来操作

免测的测试单, 需要开发自己来操作.


## 五、发布后要做的事情

### 1. 发布当日：观察视图

http://monitor.server.com/link/graph/viewid:6196

确认几个关键指标（进入量，badjs量，失败量...)视图正常！

视发布改动大小和重要程度，发布后需要观察视图半小时-1小时。

### 2. 发布当日：打tag

打tag的时机：确认发布完成，视图基本正常后，即可打tag

tag打在项目的tags目录下，命名规则根据项目自行约定。

以群文件为例：

客户端内嵌页clt_filetab：
 - 开发目录：
  `trunk/htdocs/pan.qun.qq.com/clt_filetab/docs`
 - 线上路径：
  `http://pan.qun.qq.com/clt_filetab/`
 - 打tag目录：
  `tags/pan.qun.qq.com/clt_filetab/20131225_v2.0.1_js2.0.1`
   - `20131225` 发布时间
   - v`2.0.1` 发布迭代版本号(2-二期, 0-首个迭代版本, 1-首个hotfix)
   - js`2.0.1` 发布资源的版本号

## 六、线上bug修复流程

线上bug修复我们采用bugfix分支发布策略。

前述tag管理方式下，只要是release到线上的版本必然有一个tag

以修复clt_filetab的线上bug为例，修复步骤如下：

###1. 准备

检查svn版本库内，`branches/pan.qun.qq.com/clt_filetab_bugfix`下是否有文件
  - 有文件： 和同事确认后（也许项目大了，有另一个同事也在拉分支bugfix，里面提交了未发布的bugfix代码）, 直接在svn上删除这个目录。然后去第2步
  - 无文件： 直接去第2步

###2. 从tag拉bugfix分支

从线上版本的tag，拉分支到`branches/pan.qun.qq.com/clt_filetab_bugfix`下

![Alt text](data:image,local://1388043628463)

![Alt text](data:image,local://1388043706109)

###3. 在bugfix分支修复bug

在clt_filetab_bugfix分支下修复bug并编译、提交svn

注意: 本例中的bugfix, 是对线上`2.0.0`的修复, 那么`发布时版本号需要+1`,即为`2.0.1`.

编译和接下来的提测同步阶段,这个版本号需要注意保持一致正确.


###4. 提测、发布bugfix分支

步骤还是上面的那些编译、提测、发布步骤。

注意：提测时使用的web发布系统项目是这个：[群共享_clt_filetab_bugfix](http://svn.server.com/index.php/PublishItem/index/public_id/300)

###5. 发布后的善后事宜：

1） bugfix分支上的bugfix代码，合并入主干

可以手动合，也可以借助svn的分支合并功能合并。

多人协作时注意冲突的处理即可。

2） 给bugfix分支打tag

还是按照前述规则打tag

本例就是:

  - tag来源: `branches/pan.qun.qq.com/clt_filetab_bugfix`

  - tag目标: `tags/pan.qun.qq.com/clt_filetab/20131225_v2.0.1_js2.0.1`


3） 删除bugfix分支


#### 数据上报
- 上报的代码怎么找?
上报的代码统一配置在 src\js\common\g_cfg_proj.js
根据这里面的字符串在代码里搜索即可

- 如何看上报数据?
产品类上报: 请咨询danyye. 其他数据类上报， 关注README.md 文件顶部
