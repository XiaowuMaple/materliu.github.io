---
layout: post
title: QQ 查找登录态问题 - Common Api 调用以及后续总结
---

## QQ 查找登录态问题 - Common Api 调用以及后续总结

再次感谢平台部 henryguo & herbertliu 关于 Common Api 的分享和指导。
 
现将 【QQ 查找登录态问题】跟进结果总结如下：
1、客户端从 1.90+ 版本支持 Common Api ，api wiki 可见附件
2、QQ 查找于1.90+ 开始 Web 化，并一直支持 Common Api 中窗口类（Window）、联系人类（Contact）、IM客户端类（IM） 3个类别高级 Api
3、从反馈中得知登录态问题以及解决方式如下：
1）有一定概率打开 QQ 查找无法正常种入 uin skey
解决方案：页面初始化后立刻校验是否有登录态，若无，则使用 Common Api 获取后由页面种入
2）窗口长期挂着，导致登录态过期
解决方案：所有的 CGI 请求进行登录态过期保护逻辑，一旦发现后台返回登录态过期错误码，使用Common Api 更新登录态后，再次发起 CGI 请求
 
以上解决方案均已改造完毕和提交测试，将跟随最近一次发布到外网，请各位周知。
至此，关于窗口登录态问题应该可以得到解决，发布后我们将持续关注相关数据变化。

Hi, All:
关于【 QQ查找登录态问题 】，之前尝试通过 Common Api 从前端去解决。具体方案见之前邮件。
由于登录态问题属于非必现随机问题，只能通过对外发布并结合数据上报观察情况。
前端的修复版本发布后，发现 CGI 的授权验证失败上报量并没有明显变化。
前端又多次在关键点增加了数据上报，监控 Common Api 相关调用情况，先将情况汇总如下：
 
1、首次打开无登录态情况，大概占pv的 0.2% - 0.3%
此时通过 Common Api GetSKey 接口获取skey同样返回空，{errorCode:2, sKey:''}
Lucky同学定位：首屏打开无登录态，不是种不进去，是客户端真的没有 sKey
结论：首次打开无登录态情况，无法通过 Common Api 解决
 
2、关于登录态续期
客户端会时钟在内存中保持最新有效的 sKey，每隔1小时更新一次，但是不会写入到具体业务已经打开的窗口 cookie  实体中。
前端检测到登录态过期，通过 Common Api 能够正常获取最新 sKey，但是通过 js 无法实时修改 cookie 实体中uin，skey的值。举例如下：
cookie.get('skey');   // skey为 ZOab2zpBaY
cookie.set('skey', '12345');
cookie.get('skey');   // 再次获取skey 仍然是 ZOab2zpBaY
必须关闭窗口，再次打开
cookie.get('skey');   // 此时skey的值为 12345
Lucky同学协助定位：客户端的 cookie 是内存 cookie，通过 Common Api 获取可能始终是内存 cookie
结论：此处应该是客户端 bug。目前 Common Api 没有提供 setCookie 方法，所以这个bug无法绕过，只能客户端解决
 
3、Common Api 支持的客户端版本
数据上报显示，之前对 QQ 查找web化窗口支持 Common Api 的情况总结有误，纠正如下：
QQ查找从1.90开始web化，而客户端1.91才支持Common Api，所以1.90的版本无法使用 Api 接口
 
总结：
通过 Common Api 解决首次无登录态、和登录态续期，由于上述原因，没有起到任何效果；这跟后台数据鉴权失败上报吻合。
 
QQ 查找前端后续尝试方案：
1、首次无登录态：数据上报中发现，sKey虽然为空，clientKey能正常获取到，下一步，QQ 查找将尝试利用 ClientKey 进行一次 Ptlogin跳转解决
2、登录态续期：会让后台同学提供一个用于续期的轻量级cgi，由前端定期访问达到续期目的（由于服务器限制，最长只能续期24小时），之前预研可行。
 
相关建议，希望parike、applechang可以帮忙反馈和跟进
1、QQ 越来越多Web化模块，而登录态是Web所有鉴权的关键，希望可以从底层地位并解决，这样能大大减低web模块各自兼容成本
2、QQ 首次打开无登录态，这个bug提给底层开发同学已经有一段时间了，有最新进展吗？
3、内存 Cookie 的bug，是本次定位问题新发现的，需要修复
4、Web窗口续期，了解客户端本身在内存中做了skey续期，为何不考虑续期后同时在web窗口中种入并更新呢，这样就可以减少web主动续期工作？